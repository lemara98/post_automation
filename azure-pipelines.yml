# Azure DevOps Pipeline for Betania Content Automation
# Deploys Azure Functions using Terraform

trigger:
  branches:
    include:
      - main
      - master
  paths:
    exclude:
      - README.md
      - docs/**
      - '*.md'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: betania-content-secrets  # Create this variable group in Azure DevOps
  - name: pythonVersion
    value: '3.11'
  - name: terraformVersion
    value: '1.6.0'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildPython
        displayName: 'Build Python Function App'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'
            workingDirectory: '$(workingDirectory)'

          - script: |
              # Run tests
              python test_setup.py || true  # Don't fail on test errors initially
            displayName: 'Run tests'
            workingDirectory: '$(workingDirectory)'

          - task: ArchiveFiles@2
            displayName: 'Archive function app'
            inputs:
              rootFolderOrFile: '$(workingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              replaceExistingArchive: true
              verbose: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifacts'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'function-app'
              publishLocation: 'Container'

  - stage: Infrastructure
    displayName: 'Provision Infrastructure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Terraform
        displayName: 'Terraform Apply'
        steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(workingDirectory)/terraform'
              backendServiceArm: 'Azure-ServiceConnection'  # Configure this
              backendAzureRmResourceGroupName: 'betania-terraform-state'
              backendAzureRmStorageAccountName: 'betaniatfstate'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'content-automation.tfstate'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(workingDirectory)/terraform'
              commandOptions: '-out=tfplan'
              environmentServiceNameAzureRM: 'Azure-ServiceConnection'
            env:
              TF_VAR_openai_api_key: $(OPENAI_API_KEY)
              TF_VAR_wordpress_username: $(WORDPRESS_USERNAME)
              TF_VAR_wordpress_password: $(WORDPRESS_PASSWORD)
              TF_VAR_wordpress_db_host: $(WORDPRESS_DB_HOST)
              TF_VAR_wordpress_db_name: $(WORDPRESS_DB_NAME)
              TF_VAR_wordpress_db_user: $(WORDPRESS_DB_USER)
              TF_VAR_wordpress_db_password: $(WORDPRESS_DB_PASSWORD)
              TF_VAR_sendgrid_api_key: $(SENDGRID_API_KEY)

          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(workingDirectory)/terraform'
              commandOptions: 'tfplan'
              environmentServiceNameAzureRM: 'Azure-ServiceConnection'

  - stage: Deploy
    displayName: 'Deploy Function App'
    dependsOn: Infrastructure
    condition: succeeded()
    jobs:
      - deployment: DeployFunctionApp
        displayName: 'Deploy to Azure Functions'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'function-app'
                    downloadPath: '$(System.ArtifactsDirectory)'

                - task: AzureFunctionApp@1
                  displayName: 'Deploy Azure Function App'
                  inputs:
                    azureSubscription: 'Azure-ServiceConnection'
                    appType: 'functionAppLinux'
                    appName: 'betania-content-prod-func'  # Must match Terraform output
                    package: '$(System.ArtifactsDirectory)/function-app/*.zip'
                    runtimeStack: 'PYTHON|3.11'
                    deploymentMethod: 'zipDeploy'

  - stage: PostDeployment
    displayName: 'Post-Deployment Verification'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: HealthCheck
        displayName: 'Health Check'
        steps:
          - script: |
              echo "Waiting 30 seconds for functions to warm up..."
              sleep 30

              echo "âœ… Deployment completed successfully!"
              echo "Function App: https://betania-content-prod-func.azurewebsites.net"
              echo ""
              echo "Next steps:"
              echo "1. Check Azure Portal for function status"
              echo "2. Review Application Insights for logs"
              echo "3. Verify scheduled functions are enabled"
            displayName: 'Post-deployment checks'
